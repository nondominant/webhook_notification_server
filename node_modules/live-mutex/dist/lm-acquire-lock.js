#!/usr/bin/env node
'use strict';
Object.defineProperty(exports, "__esModule", { value: true });
const client_utils_1 = require("./client-utils");
const client_1 = require("./client");
const chalk_1 = require("chalk");
const util = require("util");
const index = process.argv.indexOf('--json');
let v = null;
if (index > 1) {
    try {
        v = JSON.parse(process.argv[index + 1]);
    }
    catch (err) {
        client_utils_1.log.error(`Could not parse your --json argument, try --json '{"port": 3091,"key": "foo"}' ... ` +
            chalk_1.default.magenta(`run your JSON through a validator if need be.`));
        throw chalk_1.default.magentaBright(err.message);
    }
}
else {
    v = {};
    v.key = process.argv[2] || process.env.live_mutex_key || '';
    v.port = parseInt(process.argv[3] || process.env.live_mutex_port || '6970');
}
if (!Number.isInteger(v.port)) {
    client_utils_1.log.error(chalk_1.default.magenta('Live-mutex: port could not be parsed to integer from command line input.'));
    client_utils_1.log.error('Usage: lm_acquire_lock <key> <?port>');
    process.exit(1);
}
if (!v.key) {
    client_utils_1.log.error(chalk_1.default.magenta('Live-mutex: no key passed at command line.'));
    client_utils_1.log.error('Usage: lm_acquire_lock <key> <?port>');
    process.exit(1);
}
process.once('warning', function (e) {
    client_utils_1.log.error('process warning:', e && e.message || e);
});
process.once('error', function (e) {
    client_utils_1.log.error('process error:', e && e.message || e);
    process.exit(1);
});
process.once('unhandledRejection', function (e) {
    client_utils_1.log.error('unhandledRejection:', chalk_1.default.magenta(util.inspect(e)));
    process.exit(1);
});
process.once('uncaughtException', function (e) {
    client_utils_1.log.error('uncaughtException:', chalk_1.default.magenta(util.inspect(e)));
    process.exit(1);
});
const clientOpts = Object.assign({ keepLocksAfterDeath: true }, v);
const c = new client_1.Client(clientOpts);
c.emitter.on('info', function () {
    client_utils_1.log.debug(...arguments);
});
c.emitter.on('warning', function () {
    client_utils_1.log.warn(...arguments);
});
c.emitter.on('error', function () {
    client_utils_1.log.error(...arguments);
});
c.ensure().then(function (c) {
    const lockOptions = Object.assign({ ttl: null, keepLocksAfterDeath: true }, v);
    c.lock(v.key, lockOptions, function (e) {
        c.setNoRecover();
        if (e) {
            client_utils_1.log.error(chalk_1.default.magenta.bold(e && e.message || e));
            client_utils_1.log.error(`To discover what is going on with the broker, use ${chalk_1.default.blueBright.bold('$ lm_inspect_broker -p <port> -h <host>')}.`);
            return process.exit(1);
        }
        client_utils_1.log.debug(chalk_1.default.green.bold(`${chalk_1.default.italic('Acquired')} lock for key:`), `'${chalk_1.default.blueBright.bold(v.key)}'`);
        process.exit(0);
    });
});
